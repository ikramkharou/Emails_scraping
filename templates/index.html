{% extends "base.html" %}

{% block title %}Gmail Scraper Pro - Authentication{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-xl-6">
                 <!-- Hero Section -->
         <div class="text-center mb-5">
            <div class="icon-large">
                <i class="fas fa-envelope-open-text" style="color: #01214d;"></i>
            </div>
            <h1 class="display-4 fw-bold mb-3" style="color: #01214d;">Mail Scraper Extractor </h1>
            <p class="lead text-muted mb-0">Professional Email Data Extraction Tool â€” Raw RFC822  </p>
            <p class="text-secondary">Extract, analyze, and export your email data with enterprise-grade security</p>
        </div>

                 <!-- Tab Navigation -->
         <ul class="nav nav-tabs mb-4" id="authTabs" role="tablist">
             <li class="nav-item" role="presentation">
                 <button class="nav-link active small" id="gmail-tab" data-bs-toggle="tab" data-bs-target="#gmail-content" type="button" role="tab">
                     <i class="fas fa-envelope me-1"></i>Gmail API
                 </button>
             </li>
             <li class="nav-item" role="presentation">
                 <button class="nav-link small" id="imap-tab" data-bs-toggle="tab" data-bs-target="#imap-content" type="button" role="tab">
                     <i class="fas fa-server me-1"></i>IMAP
                 </button>
             </li>
         </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="authTabContent">
            <!-- Gmail API Tab -->
            <div class="tab-pane fade show active" id="gmail-content" role="tabpanel">
                 <!-- Main Authentication Card -->
         <div class="card">
            <div class="card-body p-4">
                <form method="POST" action="{{ url_for('authenticate') }}" class="needs-validation" novalidate>
                    <div class="mb-4">
                        <label for="email" class="form-label">
                            Gmail Address
                        </label>
                        <input 
                            type="email" 
                            class="form-control" 
                            id="email" 
                            name="email" 
                            placeholder="Enter your Gmail address"
                            required
                            pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                        >
                        <div class="form-text">
                            This will be used to identify your account during the scraping process
                        </div>
                        <div class="invalid-feedback">
                            Please enter a valid Gmail address.
                        </div>
                    </div>

                                                         <div class="d-flex justify-content-center">
                                 <button type="submit" class="btn btn-sm px-4" style="background-color: #55729b; color: white; border-color: #224577; min-width: 200px;">
                                     <i class="fas fa-sign-in-alt me-2"></i>Start Authentication
                        </button>
                    </div>
                </form>
                    </div>
            </div>
        </div>

                         <!-- IMAP Tab -->
             <div class="tab-pane fade" id="imap-content" role="tabpanel">
                 <!-- Simple Professional IMAP Configuration Card -->
                 <div class="card border" style="background-color: white;">
                     <div class="card-header bg-light border-bottom py-3">
                         <h6 class="mb-0 text-dark">
                             <i class="fas fa-server me-2"></i>
                             IMAP Email Configuration
                         </h6>
                     </div>
                     <div class="card-body p-3">
                         <form id="imapForm" class="needs-validation" novalidate>
                             <!-- Simple Info Text -->
                             <div class="mb-2 text-muted small">
                                 <i class="fas fa-info-circle me-1"></i>
                                 Enter your email credentials. For Gmail, use an App Password if 2FA is enabled.
                             </div>

                             <!-- Email & Password Row -->
                             <div class="row mb-3">
                                 <div class="col-md-6">
                                     <label for="imapEmail" class="form-label small">Email Address</label>
                                     <input type="email" class="form-control form-control-sm" id="imapEmail" placeholder="Enter your email address" style="border-color: #dee2e6;" required>
                                     <div class="invalid-feedback small">
                                         Please enter a valid email address.
                                     </div>
                                 </div>
                                 <div class="col-md-6">
                                     <label for="imapPassword" class="form-label small">Password/App Password</label>
                                     <input type="password" class="form-control form-control-sm" id="imapPassword" placeholder="Enter your password or app password" style="border-color: #dee2e6;" required>
                                     <div class="invalid-feedback small">
                                         Password is required.
                                     </div>
                                 </div>
                             </div>
                             
                             <!-- Server & Port Row -->
                             <div class="row mb-3">
                                 <div class="col-md-8">
                                     <label for="imapServer" class="form-label small">IMAP Server</label>
                                     <select class="form-select form-select-sm" id="imapServer" style="border-color: #dee2e6;">
                                         <option value="">Auto-detect</option>
                                         <option value="imap.gmail.com">Gmail (imap.gmail.com)</option>
                                         <option value="outlook.office365.com">Outlook (outlook.office365.com)</option>
                                         <option value="imap.mail.yahoo.com">Yahoo (imap.mail.yahoo.com)</option>
                                         <option value="imap.aol.com">AOL (imap.aol.com)</option>
                                         <option value="custom">Custom...</option>
                                     </select>
                                     <!-- Custom Server Input (hidden by default) -->
                                     <input type="text" class="form-control form-control-sm mt-2" id="customImapServer" placeholder="Enter custom IMAP server (e.g., mail.example.com)" style="border-color: #dee2e6; display: none;">
                                 </div>
                                 <div class="col-md-4">
                                     <label for="imapPort" class="form-label small">Port</label>
                                     <input type="number" class="form-control form-control-sm" id="imapPort" placeholder="993" value="993" min="1" max="65535" style="border-color: #dee2e6;">
                                 </div>
                             </div>
                             
                             <!-- SSL Row -->
                             <div class="row mb-3">
                                 <div class="col-md-6">
                                     <div class="form-check">
                                         <input class="form-check-input" type="checkbox" id="imapUseSSL" checked>
                                         <label class="form-check-label small" for="imapUseSSL">
                                             Use SSL/TLS
                                         </label>
                                     </div>
                                 </div>
                             </div>

                             <!-- Simple Buttons Row -->
                             <div class="row mt-3">
                                 <div class="col-md-6">
                                     <button type="button" id="testImapBtn" class="btn btn-sm w-100" style="background-color: white; color: #6c757d; border: 1px solid #dee2e6;">
                                         <i class="fas fa-plug me-1"></i>Test Connection
                                     </button>
                                 </div>
                                 <div class="col-md-6">
                                     <button type="button" id="startImapBtn" class="btn btn-sm w-100" style="background-color: #55729b; color: white; border: 1px solid #224577;">
                                         <i class="fas fa-download me-1"></i>Start Scraping
                                     </button>
                                 </div>
                             </div>
                         </form>
                     </div>
                 </div>
             </div>
                 </div>
     </div>
 </div>

 <!-- Toast Notification Container -->
 <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
     <div id="imapToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="background-color: #f8fff9; border: 1px solid #d4edda;">
         <div class="toast-header" style="background-color: #d4edda; border-bottom: 1px solid #c3e6cb;">
             <i id="toastIcon" class="fas fa-info-circle me-2"></i>
             <strong id="toastTitle" class="me-auto">IMAP Connection</strong>
             <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
         </div>
         <div id="toastBody" class="toast-body" style="color: #155724;">
             <!-- Toast content will be inserted here -->
         </div>
    </div>
</div>

<script>
// Form validation and submission handling for Gmail API
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                } else {
                    // Form is valid, just submit without changing button
                    // No loading state to prevent size changes
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Email validation for Gmail API
document.getElementById('email').addEventListener('input', function() {
    const email = this.value;
    const gmailPattern = /^[a-zA-Z0-9._%+-]+@gmail\.com$/;
    
    if (email && !gmailPattern.test(email)) {
        this.setCustomValidity('Please enter a valid Gmail address');
    } else {
        this.setCustomValidity('');
    }
});

// IMAP Functions
function autoDetectImapServer() {
    const email = document.getElementById('imapEmail').value;
    const serverSelect = document.getElementById('imapServer');
    
    if (email && email.includes('@')) {
        const domain = email.split('@')[1].toLowerCase();
        
        // Common IMAP servers
        const servers = {
            'gmail.com': 'imap.gmail.com',
            'outlook.com': 'outlook.office365.com',
            'hotmail.com': 'outlook.office365.com',
            'yahoo.com': 'imap.mail.yahoo.com',
            'aol.com': 'imap.aol.com',
            'yandex.com': 'imap.yandex.com'
        };
        
        if (servers[domain]) {
            serverSelect.value = servers[domain];
        }
    }
}

function getImapFormData() {
    const email = document.getElementById('imapEmail').value;
    const password = document.getElementById('imapPassword').value;
    const server = document.getElementById('imapServer').value;
    const customServer = document.getElementById('customImapServer').value;
    const port = document.getElementById('imapPort').value;
    const useSSL = document.getElementById('imapUseSSL').checked;
    
    if (!email || !password) {
        showToast('error', 'Validation Error', 'Email address and password are required');
        return null;
    }
    
    // Use custom server if selected, otherwise use selected server
    const finalServer = server === 'custom' ? customServer : server;
    
    if (server === 'custom' && !customServer) {
        showToast('error', 'Validation Error', 'Please enter a custom IMAP server address');
        return null;
    }
    
    return {
        email_address: email,
        password: password,
        imap_server: finalServer || null,
        imap_port: port ? parseInt(port) : null,
        use_ssl: useSSL
    };
}

function testImapConnection() {
    const formData = getImapFormData();
    if (!formData) return;
    
    const btn = document.getElementById('testImapBtn');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Testing...';
    btn.disabled = true;
    
    fetch('/test_imap_connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'Connection Successful', 
                `Server: ${data.imap_server}<br>Folders: ${data.folders.length} available<br>INBOX: ${data.inbox_count} emails`);
        } else {
            showToast('error', 'Connection Failed', data.error);
        }
    })
    .catch(error => {
        showToast('error', 'Network Error', error.message);
    })
    .finally(() => {
        btn.innerHTML = '<i class="fas fa-plug me-1"></i>Test Connection';
        btn.disabled = false;
    });
}

function startImapScraping() {
    const formData = getImapFormData();
    if (!formData) return;
    
    const btn = document.getElementById('startImapBtn');
    // No loading state - button stays the same
    
    // Test the connection and store credentials
    fetch('/test_imap_connection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Connection successful, store credentials and redirect
            return fetch('/store_imap_credentials', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
        } else {
            throw new Error(data.error || 'Connection failed');
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', 'Authentication Successful', 
                `Connected to: ${data.imap_server}<br>Redirecting to dashboard...`);
            // Redirect to dashboard immediately
            window.location.href = '/dashboard?auth_method=imap';
        } else {
            showToast('error', 'Authentication Failed', data.error);
        }
    })
    .catch(error => {
        showToast('error', 'Error', error.message);
    });
    // No finally block - button stays unchanged
}

// Toast notification function
function showToast(type, title, message) {
    const toast = document.getElementById('imapToast');
    const toastIcon = document.getElementById('toastIcon');
    const toastTitle = document.getElementById('toastTitle');
    const toastBody = document.getElementById('toastBody');
    
    // Set icon and color based on type
    if (type === 'success') {
        toastIcon.className = 'fas fa-check-circle me-2';
        toastIcon.style.color = '#28a745';
        toast.style.backgroundColor = '#f8fff9';
        toast.style.borderColor = '#d4edda';
        toast.querySelector('.toast-header').style.backgroundColor = '#d4edda';
        toastBody.style.color = '#155724';
    } else if (type === 'error') {
        toastIcon.className = 'fas fa-exclamation-circle me-2';
        toastIcon.style.color = '#dc3545';
        toast.style.backgroundColor = '#fff8f8';
        toast.style.borderColor = '#f5c6cb';
        toast.querySelector('.toast-header').style.backgroundColor = '#f5c6cb';
        toastBody.style.color = '#721c24';
    } else {
        toastIcon.className = 'fas fa-info-circle me-2';
        toastIcon.style.color = '#17a2b8';
        toast.style.backgroundColor = '#f8f9ff';
        toast.style.borderColor = '#cce7ff';
        toast.querySelector('.toast-header').style.backgroundColor = '#cce7ff';
        toastBody.style.color = '#004085';
    }
    
    toastTitle.textContent = title;
    toastBody.innerHTML = message;
    
    // Show the toast
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// Custom server input handling
function handleServerSelection() {
    const serverSelect = document.getElementById('imapServer');
    const customInput = document.getElementById('customImapServer');
    
    if (serverSelect.value === 'custom') {
        customInput.style.display = 'block';
        customInput.required = true;
    } else {
        customInput.style.display = 'none';
        customInput.required = false;
        customInput.value = '';
    }
}

// Event listeners for IMAP
document.addEventListener('DOMContentLoaded', function() {
    // Auto-detect server when email changes
    document.getElementById('imapEmail').addEventListener('change', autoDetectImapServer);
    
    // Handle server selection changes
    document.getElementById('imapServer').addEventListener('change', handleServerSelection);
    
    // IMAP button event listeners
    document.getElementById('testImapBtn').addEventListener('click', testImapConnection);
    document.getElementById('startImapBtn').addEventListener('click', startImapScraping);
    
    // Debug: Log form submission attempts for Gmail API
    const form = document.querySelector('form[action*="authenticate"]');
    if (form) {
        console.log('Gmail API form found:', form);
        form.addEventListener('submit', function(e) {
            console.log('Gmail API form submission attempted');
            console.log('Form action:', this.action);
            console.log('Form method:', this.method);
            console.log('Form valid:', this.checkValidity());
        });
    }
});
</script>
{% endblock %}
